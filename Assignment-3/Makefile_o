# Makefile for Assignment-3

# Compiler (default: nvc++)
CXX = nvc++

# Options
OPT = -O3
CHIP =
ISA =
PARA = -mp
GPU = -acc -gpu=cc88
XOPTS =

# Combine flags
CXXFLAGS = $(OPT) $(CHIP) $(ISA) $(PARA) $(GPU) $(XOPTS)
LDFLAGS = -lm

# Sources
COMMON_SRCS = alloc3d.cpp init.cpp timing.cpp print.cpp
COMMON_OBJS = $(COMMON_SRCS:.cpp=.o)

JACOBI_SRCS = jacobi.cpp
JACOBI_OBJS = $(JACOBI_SRCS:.cpp=.o)


MATMULT_SRCS = matmult.cpp
MATMULT_OBJS = $(MATMULT_SRCS:.cpp=.o)

# Targets
TARGET_J = poisson_j
TARGET_LIB = libmatmult.so

all: $(TARGET_J) $(TARGET_GS) $(TARGET_LIB)

$(TARGET_J): main_j.o $(COMMON_OBJS) $(JACOBI_OBJS)
	$(CXX) $(CXXFLAGS) -o $@ $^ $(LDFLAGS)

$(TARGET_LIB): $(MATMULT_OBJS)
	$(CXX) $(CXXFLAGS) -shared -o $@ $^ $(LDFLAGS)

main_j.o: main.cpp
	$(CXX) $(CXXFLAGS) -D_JACOBI -c $< -o $@

%.o: %.cpp
	$(CXX) $(CXXFLAGS) -c $< -o $@

clean:
	rm -f *.o

realclean: clean
	rm -f $(TARGET_J) $(TARGET_GS) $(TARGET_LIB)
